name: DI + Controllers Regression Tests

on:
  push:
    branches: [main, fix/e2e-di-controllers-regression]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.11', '3.12']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pytest-asyncio httpx
      
      - name: Run DI regression tests
        run: |
          python -m pytest tests/e2e/di/ -v --tb=short --junitxml=tests/e2e/report-di.xml
      
      - name: Run controller DI stress tests
        run: |
          python -m pytest tests/e2e/controllers/test_controller_di_stress.py -v --tb=short --junitxml=tests/e2e/report-stress.xml
      
      - name: Run full E2E suite
        run: |
          python -m pytest tests/e2e/ -v --tb=short --junitxml=tests/e2e/report.xml
        continue-on-error: true
      
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-${{ matrix.os }}-py${{ matrix.python-version }}
          path: tests/e2e/report*.xml
      
      - name: Check for failures
        run: |
          python -m pytest tests/e2e/di/ tests/e2e/controllers/test_controller_di_stress.py --tb=line -q
