{% extends "base.html" %}

{% block topbar_title %}{{ company.name }}{% endblock %}

{% block content %}
<div class="detail-header">
    <div>
        <div class="detail-title">{{ company.name }}</div>
        <div class="detail-subtitle">
            {{ company.industry | default('') | title }}{% if company.city %} · {{ company.city }}{% if company.country %}, {{ company.country }}{% endif %}{% endif %}
        </div>
    </div>
    <div class="btn-group">
        <a href="/companies/{{ company.id }}/edit" class="btn btn-primary">Edit</a>
        <button class="btn btn-danger" onclick="deleteCompany({{ company.id }})">Delete</button>
        <a href="/companies/" class="btn btn-outline">← Back</a>
    </div>
</div>

<div class="detail-grid">
    <div>
        <div class="card mb-3">
            <div class="card-header"><h3>Company Details</h3></div>
            <div class="form-row">
                <div class="detail-field">
                    <div class="label">Industry</div>
                    <div class="value"><span class="badge badge-accent">{{ company.industry | default('-') | title }}</span></div>
                </div>
                <div class="detail-field">
                    <div class="label">Size</div>
                    <div class="value">{{ company.size | default('-') | title }}</div>
                </div>
            </div>
            <div class="form-row">
                <div class="detail-field">
                    <div class="label">Website</div>
                    <div class="value">{% if company.website %}<a href="{{ company.website }}" target="_blank">{{ company.website }}</a>{% else %}-{% endif %}</div>
                </div>
                <div class="detail-field">
                    <div class="label">Phone</div>
                    <div class="value">{{ company.phone | default('-') }}</div>
                </div>
            </div>
            <div class="form-row">
                <div class="detail-field">
                    <div class="label">Location</div>
                    <div class="value">{{ company.city | default('') }}{% if company.country %}, {{ company.country }}{% endif %}{% if not company.city and not company.country %}-{% endif %}</div>
                </div>
                <div class="detail-field">
                    <div class="label">Added</div>
                    <div class="value">{{ company.created_at | default('-') }}</div>
                </div>
            </div>
            {% if company.description %}
            <div class="detail-field">
                <div class="label">Description</div>
                <div class="value">{{ company.description }}</div>
            </div>
            {% endif %}
        </div>

        <!-- Contacts -->
        <div class="card mb-3">
            <div class="card-header">
                <h3>Contacts ({{ contacts | length }})</h3>
                <a href="/contacts/new?company_id={{ company.id }}" class="btn btn-outline btn-sm">+ Add Contact</a>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Name</th><th>Email</th><th>Status</th></tr></thead>
                    <tbody>
                        {% for c in contacts %}
                        <tr>
                            <td><a href="/contacts/{{ c.id }}">{{ c.first_name }} {{ c.last_name }}</a></td>
                            <td class="text-muted">{{ c.email | default('-') }}</td>
                            <td><span class="badge status-{{ c.status }}">{{ c.status | title }}</span></td>
                        </tr>
                        {% endfor %}
                        {% if not contacts %}
                        <tr><td colspan="3" class="text-center text-muted">No contacts</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Deals -->
        <div class="card">
            <div class="card-header">
                <h3>Deals ({{ deals | length }})</h3>
                <a href="/deals/new?company_id={{ company.id }}" class="btn btn-outline btn-sm">+ Add Deal</a>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Deal</th><th>Value</th><th>Stage</th></tr></thead>
                    <tbody>
                        {% for d in deals %}
                        <tr>
                            <td><a href="/deals/{{ d.id }}">{{ d.title }}</a></td>
                            <td class="text-success font-bold">${{ "{:,.0f}".format(d.value or 0) }}</td>
                            <td><span class="badge stage-{{ d.stage }}">{{ d.stage | replace('_', ' ') | title }}</span></td>
                        </tr>
                        {% endfor %}
                        {% if not deals %}
                        <tr><td colspan="3" class="text-center text-muted">No deals</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div>
        <div class="card mb-3">
            <div class="card-header"><h3>Summary</h3></div>
            <div class="detail-field">
                <div class="label">Total Contacts</div>
                <div class="value font-bold" style="font-size:20px">{{ contacts | length }}</div>
            </div>
            <div class="detail-field">
                <div class="label">Total Deals</div>
                <div class="value font-bold" style="font-size:20px">{{ deals | length }}</div>
            </div>
            <div class="detail-field">
                <div class="label">Total Deal Value</div>
                <div class="value font-bold text-success" style="font-size:20px">${{ "{:,.0f}".format(deals | sum(attribute='value') if deals else 0) }}</div>
            </div>
            <div class="detail-field">
                <div class="label">Owner</div>
                <div class="value">{{ company.owner_name | default('Unassigned') }}</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function deleteCompany(id) {
    if (!confirm('Delete this company and all associated data?')) return;
    const res = await apiCall(`/companies/api/${id}`, 'DELETE');
    if (res.ok) window.location = '/companies/';
}
</script>
{% endblock %}
