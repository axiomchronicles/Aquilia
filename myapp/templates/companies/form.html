{% extends "base.html" %}

{% block topbar_title %}{{ 'Edit Company' if company else 'New Company' }}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h2>{{ 'Edit Company' if company else 'New Company' }}</h2>
        <p class="subtitle">{{ 'Update company information' if company else 'Register a new organization' }}</p>
    </div>
    <a href="/companies/" class="btn btn-outline">‚Üê Back</a>
</div>

<div id="alertBox" class="alert"></div>

<div class="card" style="max-width:800px">
    <form id="companyForm" onsubmit="return handleSubmit(event)">
        <div class="form-group">
            <label class="form-label">Company Name *</label>
            <input type="text" class="form-input" id="name" value="{{ company.name | default('') }}" required>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Industry</label>
                <select class="form-select" id="industry">
                    {% for ind in ['technology', 'healthcare', 'finance', 'manufacturing', 'retail', 'consulting', 'education', 'other'] %}
                    <option value="{{ ind }}" {% if company and company.industry == ind %}selected{% endif %}>{{ ind | title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Company Size</label>
                <select class="form-select" id="size">
                    {% for s in ['startup', 'small', 'medium', 'large', 'enterprise'] %}
                    <option value="{{ s }}" {% if company and company.size == s %}selected{% endif %}>{{ s | title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Website</label>
                <input type="url" class="form-input" id="website" value="{{ company.website | default('') }}" placeholder="https://example.com">
            </div>
            <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="text" class="form-input" id="phone" value="{{ company.phone | default('') }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">City</label>
                <input type="text" class="form-input" id="city" value="{{ company.city | default('') }}">
            </div>
            <div class="form-group">
                <label class="form-label">Country</label>
                <input type="text" class="form-input" id="country" value="{{ company.country | default('') }}">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Owner</label>
            <select class="form-select" id="ownerId">
                <option value="">Unassigned</option>
                {% for u in users %}
                <option value="{{ u.id }}" {% if company and company.owner_id == u.id %}selected{% endif %}>{{ u.first_name }} {{ u.last_name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="description" placeholder="Company description...">{{ company.description | default('') }}</textarea>
        </div>

        <div class="btn-group mt-2">
            <button type="submit" class="btn btn-primary" id="submitBtn">{{ 'Update Company' if company else 'Create Company' }}</button>
            <a href="/companies/" class="btn btn-ghost">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
const isEdit = {{ 'true' if company else 'false' }};
const companyId = {{ company.id if company else 'null' }};

async function handleSubmit(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    const alert = document.getElementById('alertBox');
    btn.textContent = 'Saving...';

    const data = {
        name: document.getElementById('name').value,
        industry: document.getElementById('industry').value,
        size: document.getElementById('size').value,
        website: document.getElementById('website').value || null,
        phone: document.getElementById('phone').value || null,
        city: document.getElementById('city').value || null,
        country: document.getElementById('country').value || null,
        owner_id: document.getElementById('ownerId').value ? parseInt(document.getElementById('ownerId').value) : null,
        description: document.getElementById('description').value || null
    };

    try {
        const url = isEdit ? `/companies/api/${companyId}` : '/companies/api/';
        const method = isEdit ? 'PUT' : 'POST';
        const res = await apiCall(url, method, data);

        if (res.ok) {
            const id = isEdit ? companyId : res.data.company?.id || res.data.id;
            window.location = `/companies/${id}`;
        } else {
            alert.textContent = res.data.message || JSON.stringify(res.data.errors || res.data);
            alert.className = 'alert alert-error';
        }
    } catch (err) {
        alert.textContent = 'Connection error';
        alert.className = 'alert alert-error';
    }

    btn.textContent = isEdit ? 'Update Company' : 'Create Company';
}
</script>
{% endblock %}
