{% extends "base.html" %}

{% block topbar_title %}{{ 'Edit Deal' if deal else 'New Deal' }}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h2>{{ 'Edit Deal' if deal else 'New Deal' }}</h2>
        <p class="subtitle">{{ 'Update deal details' if deal else 'Create a new sales opportunity' }}</p>
    </div>
    <a href="/deals/" class="btn btn-outline">‚Üê Back</a>
</div>

<div id="alertBox" class="alert"></div>

<div class="card" style="max-width:800px">
    <form id="dealForm" onsubmit="return handleSubmit(event)">
        <div class="form-group">
            <label class="form-label">Deal Title *</label>
            <input type="text" class="form-input" id="title" value="{{ deal.title | default('') }}" required placeholder="e.g. Enterprise License - Acme Corp">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Value ($) *</label>
                <input type="number" class="form-input" id="value" value="{{ deal.value | default('') }}" required min="0" step="100" placeholder="50000">
            </div>
            <div class="form-group">
                <label class="form-label">Stage</label>
                <select class="form-select" id="stage">
                    {% for s in ['discovery', 'qualification', 'proposal', 'negotiation', 'closed_won', 'closed_lost'] %}
                    <option value="{{ s }}" {% if deal and deal.stage == s %}selected{% elif not deal and s == 'discovery' %}selected{% endif %}>{{ s | replace('_', ' ') | title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Contact</label>
                <select class="form-select" id="contactId">
                    <option value="">Select Contact</option>
                    {% for c in contacts %}
                    <option value="{{ c.id }}" {% if deal and deal.contact_id == c.id %}selected{% endif %}>{{ c.first_name }} {{ c.last_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Company</label>
                <select class="form-select" id="companyId">
                    <option value="">Select Company</option>
                    {% for c in companies %}
                    <option value="{{ c.id }}" {% if deal and deal.company_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Expected Close Date</label>
                <input type="date" class="form-input" id="closeDate" value="{{ deal.expected_close_date | default('') }}">
            </div>
            <div class="form-group">
                <label class="form-label">Owner</label>
                <select class="form-select" id="ownerId">
                    <option value="">Unassigned</option>
                    {% for u in users %}
                    <option value="{{ u.id }}" {% if deal and deal.owner_id == u.id %}selected{% endif %}>{{ u.first_name }} {{ u.last_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="description" placeholder="Deal notes and context...">{{ deal.description | default('') }}</textarea>
        </div>

        <div class="btn-group mt-2">
            <button type="submit" class="btn btn-primary" id="submitBtn">{{ 'Update Deal' if deal else 'Create Deal' }}</button>
            <a href="/deals/" class="btn btn-ghost">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
const isEdit = {{ 'true' if deal else 'false' }};
const dealId = {{ deal.id if deal else 'null' }};

async function handleSubmit(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    const alert = document.getElementById('alertBox');
    btn.textContent = 'Saving...';

    const data = {
        title: document.getElementById('title').value,
        value: parseFloat(document.getElementById('value').value),
        stage: document.getElementById('stage').value,
        contact_id: document.getElementById('contactId').value ? parseInt(document.getElementById('contactId').value) : null,
        company_id: document.getElementById('companyId').value ? parseInt(document.getElementById('companyId').value) : null,
        owner_id: document.getElementById('ownerId').value ? parseInt(document.getElementById('ownerId').value) : null,
        expected_close_date: document.getElementById('closeDate').value || null,
        description: document.getElementById('description').value || null
    };

    try {
        const url = isEdit ? `/deals/api/${dealId}` : '/deals/api/';
        const method = isEdit ? 'PUT' : 'POST';
        const res = await apiCall(url, method, data);

        if (res.ok) {
            const id = isEdit ? dealId : res.data.deal?.id || res.data.id;
            window.location = `/deals/${id}`;
        } else {
            alert.textContent = res.data.message || JSON.stringify(res.data.errors || res.data);
            alert.className = 'alert alert-error';
        }
    } catch (err) {
        alert.textContent = 'Connection error';
        alert.className = 'alert alert-error';
    }

    btn.textContent = isEdit ? 'Update Deal' : 'Create Deal';
}
</script>
{% endblock %}
