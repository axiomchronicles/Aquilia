{% extends "base.html" %}

{% block topbar_title %}{{ deal.title }}{% endblock %}

{% block content %}
<div class="detail-header">
    <div>
        <div class="detail-title">{{ deal.title }}</div>
        <div class="detail-subtitle">
            <span class="badge stage-{{ deal.stage }}" style="font-size:13px;padding:4px 14px">{{ deal.stage | replace('_', ' ') | title }}</span>
            <span class="text-success font-bold" style="font-size:18px;margin-left:12px">${{ "{:,.0f}".format((deal.value or 0) | float) }}</span>
        </div>
    </div>
    <div class="btn-group">
        <a href="/deals/{{ deal.id }}/edit" class="btn btn-primary">Edit</a>
        <button class="btn btn-danger" onclick="deleteDeal({{ deal.id }})">Delete</button>
        <a href="/deals/" class="btn btn-outline">‚Üê Back</a>
    </div>
</div>

<!-- Stage Progress -->
<div class="card mb-3">
    <div style="display:flex;gap:4px">
        {% set stage_order = ['discovery', 'qualification', 'proposal', 'negotiation', 'closed_won'] %}
        {% set current_idx = stage_order.index(deal.stage) if deal.stage in stage_order else -1 %}
        {% for s in stage_order %}
        {% set s_idx = loop.index0 %}
        <div style="flex:1;padding:10px;text-align:center;border-radius:var(--radius-sm);font-size:12px;font-weight:600;
            {% if s == deal.stage %}background:var(--accent);color:white{% elif current_idx >= 0 and s_idx < current_idx %}background:var(--success-subtle);color:var(--success){% else %}background:var(--bg-hover);color:var(--text-muted){% endif %}">
            {{ s | replace('_', ' ') | title }}
        </div>
        {% endfor %}
    </div>
</div>

<div class="detail-grid">
    <div>
        <div class="card mb-3">
            <div class="card-header"><h3>Deal Information</h3></div>
            <div class="form-row">
                <div class="detail-field">
                    <div class="label">Value</div>
                    <div class="value font-bold text-success" style="font-size:20px">${{ "{:,.0f}".format((deal.value or 0) | float) }}</div>
                </div>
                <div class="detail-field">
                    <div class="label">Probability</div>
                    <div class="value">{{ deal.probability | default(0) }}%</div>
                </div>
            </div>
            <div class="form-row">
                <div class="detail-field">
                    <div class="label">Contact</div>
                    <div class="value">
                        {% if deal.contact_id %}<a href="/contacts/{{ deal.contact_id }}">{{ deal.contact_name | default('Unknown') }}</a>
                        {% else %}-{% endif %}
                    </div>
                </div>
                <div class="detail-field">
                    <div class="label">Company</div>
                    <div class="value">
                        {% if deal.company_id %}<a href="/companies/{{ deal.company_id }}">{{ deal.company_name | default('Unknown') }}</a>
                        {% else %}-{% endif %}
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="detail-field">
                    <div class="label">Expected Close</div>
                    <div class="value">{{ deal.expected_close_date | default('-') }}</div>
                </div>
                <div class="detail-field">
                    <div class="label">Owner</div>
                    <div class="value">{{ deal.owner_name | default('Unassigned') }}</div>
                </div>
            </div>
            {% if deal.description %}
            <div class="detail-field">
                <div class="label">Description</div>
                <div class="value">{{ deal.description }}</div>
            </div>
            {% endif %}
        </div>

        <!-- Related Tasks -->
        <div class="card mb-3">
            <div class="card-header">
                <h3>Tasks</h3>
                <a href="/tasks/new?deal_id={{ deal.id }}" class="btn btn-outline btn-sm">+ Add Task</a>
            </div>
            {% for task in tasks %}
            <div class="activity-item">
                <div class="activity-dot" style="background:{% if task.status == 'completed' %}var(--success){% elif task.status == 'in_progress' %}var(--info){% else %}var(--warning){% endif %}"></div>
                <div class="activity-content">
                    <div class="flex justify-between items-center">
                        <a href="/tasks/{{ task.id }}" style="font-size:13px">{{ task.title }}</a>
                        <span class="badge status-{{ task.status }}" style="font-size:10px">{{ task.status | replace('_', ' ') | title }}</span>
                    </div>
                    <div class="activity-time">Due: {{ task.due_date | default('No date') }}</div>
                </div>
            </div>
            {% endfor %}
            {% if not tasks %}<div class="text-center text-muted" style="padding:20px;font-size:13px">No tasks</div>{% endif %}
        </div>

        <!-- Notes -->
        <div class="card">
            <div class="card-header">
                <h3>Notes</h3>
                <button class="btn btn-outline btn-sm" onclick="document.getElementById('noteForm').style.display='block'">+ Add Note</button>
            </div>
            <div id="noteForm" style="display:none;margin-bottom:16px">
                <textarea class="form-textarea" id="noteContent" placeholder="Write a note..."></textarea>
                <div class="btn-group mt-1">
                    <button class="btn btn-primary btn-sm" onclick="addNote()">Save Note</button>
                    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('noteForm').style.display='none'">Cancel</button>
                </div>
            </div>
            {% for note in notes %}
            <div class="activity-item">
                <div class="activity-dot"></div>
                <div class="activity-content">
                    <div class="activity-text">{{ note.content }}</div>
                    <div class="activity-time">{{ note.created_at }} ‚Äî {{ note.author_name | default('System') }}</div>
                </div>
            </div>
            {% endfor %}
            {% if not notes %}<div class="text-center text-muted" style="padding:20px;font-size:13px">No notes</div>{% endif %}
        </div>
    </div>

    <div>
        <!-- Stage Actions -->
        <div class="card mb-3">
            <div class="card-header"><h3>Stage Actions</h3></div>
            <div id="stageActions">
                {% if deal.stage not in ['closed_won', 'closed_lost'] %}
                <p class="text-muted" style="font-size:13px;margin-bottom:12px">Move to next stage:</p>
                {% set transitions = {
                    'discovery': ['qualification', 'closed_lost'],
                    'qualification': ['proposal', 'closed_lost'],
                    'proposal': ['negotiation', 'closed_lost'],
                    'negotiation': ['closed_won', 'closed_lost']
                } %}
                {% for next_stage in transitions.get(deal.stage, []) %}
                <button class="btn {% if next_stage == 'closed_won' %}btn-success{% elif next_stage == 'closed_lost' %}btn-danger{% else %}btn-primary{% endif %} btn-sm"
                    style="width:100%;justify-content:center;margin-bottom:8px"
                    onclick="moveStage('{{ next_stage }}')">
                    {% if next_stage == 'closed_won' %}üèÜ Won{% elif next_stage == 'closed_lost' %}‚úñ Lost{% else %}‚Üí {{ next_stage | replace('_', ' ') | title }}{% endif %}
                </button>
                {% endfor %}
                {% else %}
                <p class="text-muted" style="font-size:13px">This deal is {{ deal.stage | replace('_', ' ') }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card">
            <div class="card-header"><h3>Deal Stats</h3></div>
            <div class="detail-field">
                <div class="label">Weighted Value</div>
                <div class="value font-bold">${{ "{:,.0f}".format(((deal.value or 0) | float) * ((deal.probability or 0) | float) / 100) }}</div>
            </div>
            <div class="detail-field">
                <div class="label">Created</div>
                <div class="value">{{ deal.created_at | default('-') }}</div>
            </div>
            <div class="detail-field">
                <div class="label">Last Updated</div>
                <div class="value">{{ deal.updated_at | default('-') }}</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function deleteDeal(id) {
    if (!confirm('Delete this deal?')) return;
    const res = await apiCall(`/deals/api/${id}`, 'DELETE');
    if (res.ok) window.location = '/deals/';
}

async function moveStage(stage) {
    if (!confirm(`Move deal to ${stage.replace('_', ' ')}?`)) return;
    const res = await apiCall(`/deals/api/{{ deal.id }}/stage`, 'PUT', { stage });
    if (res.ok) window.location.reload();
    else alert(res.data.message || 'Stage transition failed');
}

async function addNote() {
    const content = document.getElementById('noteContent').value.trim();
    if (!content) return;
    const res = await apiCall('/deals/api/{{ deal.id }}/notes', 'POST', { content });
    if (res.ok) window.location.reload();
}
</script>
{% endblock %}
