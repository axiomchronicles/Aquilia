{% extends "base.html" %}

{% block topbar_title %}Pipeline Board{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h2>Sales Pipeline</h2>
        <p class="subtitle">Drag and drop to move deals between stages</p>
    </div>
    <div class="btn-group">
        <a href="/deals/" class="btn btn-outline">üìã List View</a>
        <a href="/deals/new" class="btn btn-primary">+ New Deal</a>
    </div>
</div>

<!-- Pipeline Summary Stats -->
{% if stats %}
<div class="kpi-grid" style="margin-bottom:20px">
    <div class="kpi-card kpi-accent" style="padding:12px 16px">
        <div class="kpi-label" style="font-size:11px">Total Pipeline</div>
        <div class="kpi-value" style="font-size:20px" id="totalPipeline">$0</div>
    </div>
    <div class="kpi-card kpi-purple" style="padding:12px 16px">
        <div class="kpi-label" style="font-size:11px">Weighted</div>
        <div class="kpi-value" style="font-size:20px" id="totalWeighted">$0</div>
    </div>
    <div class="kpi-card kpi-success" style="padding:12px 16px">
        <div class="kpi-label" style="font-size:11px">Won</div>
        <div class="kpi-value" style="font-size:20px" id="totalWon">$0</div>
    </div>
    <div class="kpi-card kpi-danger" style="padding:12px 16px">
        <div class="kpi-label" style="font-size:11px">Lost</div>
        <div class="kpi-value" style="font-size:20px" id="totalLost">$0</div>
    </div>
</div>
{% endif %}

<!-- Pipeline Board -->
<div class="pipeline-board">
    {% set stage_configs = [
        ('discovery', 'info', 'üîç'),
        ('qualification', 'purple', 'üéØ'),
        ('proposal', 'warning', 'üìÑ'),
        ('negotiation', 'accent', 'ü§ù'),
        ('closed_won', 'success', 'üèÜ'),
        ('closed_lost', 'danger', '‚úñ')
    ] %}

    {% for stage_key, color, icon in stage_configs %}
    <div class="pipeline-column" data-stage="{{ stage_key }}">
        <div class="pipeline-header">
            <h4>{{ icon }} {{ stage_key | replace('_', ' ') | title }}</h4>
            <span class="pipeline-count">{{ (board[stage_key] | default([])) | length }}</span>
        </div>
        <div class="pipeline-cards" id="stage-{{ stage_key }}"
             ondragover="event.preventDefault();this.style.background='var(--bg-hover)'"
             ondragleave="this.style.background=''"
             ondrop="handleDrop(event, '{{ stage_key }}');this.style.background=''">
            {% for deal in board.get(stage_key, []) %}
            <div class="pipeline-deal" draggable="true" data-deal-id="{{ deal.id }}"
                 ondragstart="event.dataTransfer.setData('dealId', '{{ deal.id }}')"
                 onclick="window.location='/deals/{{ deal.id }}'">
                <div class="deal-title">{{ deal.title }}</div>
                <div class="deal-value">${{ "{:,.0f}".format((deal.value or 0) | float) }}</div>
                <div class="deal-contact">
                    {{ deal.contact_name | default('No contact') }}
                    {% if deal.company_name %} ¬∑ {{ deal.company_name }}{% endif %}
                </div>
                <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
                    <span class="text-muted" style="font-size:11px">{{ deal.probability | default(0) }}% prob</span>
                    {% if deal.expected_close_date %}
                    <span class="text-muted" style="font-size:11px">{{ deal.expected_close_date }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% if not board.get(stage_key, []) %}
            <div class="text-center text-muted" style="padding:40px 16px;font-size:13px">
                No deals
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
{% if stats %}
document.getElementById('totalPipeline').textContent = formatCurrency({{ stats.pipeline_value | default(0) }});
document.getElementById('totalWeighted').textContent = formatCurrency({{ stats.weighted_pipeline | default(0) }});
document.getElementById('totalWon').textContent = formatCurrency({{ stats.won_value | default(0) }});
document.getElementById('totalLost').textContent = formatCurrency({{ stats.lost_value | default(0) }});
{% endif %}

async function handleDrop(event, newStage) {
    event.preventDefault();
    const dealId = event.dataTransfer.getData('dealId');
    if (!dealId) return;

    try {
        const res = await apiCall(`/deals/api/${dealId}/stage`, 'PUT', { stage: newStage });
        if (res.ok) {
            window.location.reload();
        } else {
            alert(res.data.message || 'Cannot move to this stage');
        }
    } catch (err) {
        alert('Failed to update deal stage');
    }
}
</script>
{% endblock %}
