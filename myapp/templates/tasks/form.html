{% extends "base.html" %}

{% block topbar_title %}{{ 'Edit Task' if task else 'New Task' }}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h2>{{ 'Edit Task' if task else 'New Task' }}</h2>
        <p class="subtitle">{{ 'Update task details' if task else 'Create a new action item' }}</p>
    </div>
    <a href="/tasks/" class="btn btn-outline">‚Üê Back</a>
</div>

<div id="alertBox" class="alert"></div>

<div class="card" style="max-width:800px">
    <form id="taskForm" onsubmit="return handleSubmit(event)">
        <div class="form-group">
            <label class="form-label">Task Title *</label>
            <input type="text" class="form-input" id="title" value="{{ task.title | default('') }}" required placeholder="e.g. Follow up with client">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Type</label>
                <select class="form-select" id="taskType">
                    {% for t in ['call', 'email', 'meeting', 'follow_up', 'demo', 'proposal', 'other'] %}
                    <option value="{{ t }}" {% if task and task.task_type == t %}selected{% endif %}>{{ t | replace('_', ' ') | title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Priority</label>
                <select class="form-select" id="priority">
                    {% for p in ['low', 'medium', 'high', 'urgent'] %}
                    <option value="{{ p }}" {% if task and task.priority == p %}selected{% elif not task and p == 'medium' %}selected{% endif %}>{{ p | title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select" id="status">
                    {% for s in ['pending', 'in_progress', 'completed', 'cancelled'] %}
                    <option value="{{ s }}" {% if task and task.status == s %}selected{% elif not task and s == 'pending' %}selected{% endif %}>{{ s | replace('_', ' ') | title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Due Date</label>
                <input type="date" class="form-input" id="dueDate" value="{{ task.due_date | default('') }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Assignee</label>
                <select class="form-select" id="assigneeId">
                    <option value="">Unassigned</option>
                    {% for u in users %}
                    <option value="{{ u.id }}" {% if task and task.assignee_id == u.id %}selected{% endif %}>{{ u.first_name }} {{ u.last_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Contact</label>
                <select class="form-select" id="contactId">
                    <option value="">No Contact</option>
                    {% for c in contacts %}
                    <option value="{{ c.id }}" {% if task and task.contact_id == c.id %}selected{% elif prefill_contact == c.id %}selected{% endif %}>{{ c.first_name }} {{ c.last_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Related Deal</label>
            <select class="form-select" id="dealId">
                <option value="">No Deal</option>
                {% for d in deals %}
                <option value="{{ d.id }}" {% if task and task.deal_id == d.id %}selected{% elif prefill_deal == d.id %}selected{% endif %}>{{ d.title }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="description" placeholder="Task details...">{{ task.description | default('') }}</textarea>
        </div>

        <div class="btn-group mt-2">
            <button type="submit" class="btn btn-primary" id="submitBtn">{{ 'Update Task' if task else 'Create Task' }}</button>
            <a href="/tasks/" class="btn btn-ghost">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
const isEdit = {{ 'true' if task else 'false' }};
const taskId = {{ task.id if task else 'null' }};

async function handleSubmit(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    const alert = document.getElementById('alertBox');
    btn.textContent = 'Saving...';

    const data = {
        title: document.getElementById('title').value,
        task_type: document.getElementById('taskType').value,
        priority: document.getElementById('priority').value,
        status: document.getElementById('status').value,
        due_date: document.getElementById('dueDate').value || null,
        assignee_id: document.getElementById('assigneeId').value ? parseInt(document.getElementById('assigneeId').value) : null,
        contact_id: document.getElementById('contactId').value ? parseInt(document.getElementById('contactId').value) : null,
        deal_id: document.getElementById('dealId').value ? parseInt(document.getElementById('dealId').value) : null,
        description: document.getElementById('description').value || null
    };

    try {
        const url = isEdit ? `/tasks/api/${taskId}` : '/tasks/api/';
        const method = isEdit ? 'PUT' : 'POST';
        const res = await apiCall(url, method, data);

        if (res.ok) {
            const id = isEdit ? taskId : res.data.task?.id || res.data.id;
            window.location = `/tasks/${id}`;
        } else {
            alert.textContent = res.data.message || JSON.stringify(res.data.errors || res.data);
            alert.className = 'alert alert-error';
        }
    } catch (err) {
        alert.textContent = 'Connection error';
        alert.className = 'alert alert-error';
    }

    btn.textContent = isEdit ? 'Update Task' : 'Create Task';
}
</script>
{% endblock %}
