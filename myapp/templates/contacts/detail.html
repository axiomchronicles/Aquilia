{% extends "base.html" %}

{% block topbar_title %}Contact Detail{% endblock %}

{% block content %}
<div class="detail-header">
    <div>
        <div class="detail-title">{{ contact.first_name }} {{ contact.last_name }}</div>
        <div class="detail-subtitle">
            {{ contact.title | default('') }}{% if contact.company_name %} at {{ contact.company_name }}{% endif %}
        </div>
    </div>
    <div class="btn-group">
        <a href="/contacts/{{ contact.id }}/edit" class="btn btn-primary">Edit Contact</a>
        <button class="btn btn-danger" onclick="deleteContact({{ contact.id }})">Delete</button>
        <a href="/contacts/" class="btn btn-outline">‚Üê Back</a>
    </div>
</div>

<div class="detail-grid">
    <div>
        <!-- Contact Info -->
        <div class="card mb-3">
            <div class="card-header">
                <h3>Contact Information</h3>
                <span class="badge status-{{ contact.status }}">{{ contact.status | title }}</span>
            </div>
            <div class="form-row">
                <div class="detail-field">
                    <div class="label">Email</div>
                    <div class="value"><a href="mailto:{{ contact.email }}">{{ contact.email | default('-') }}</a></div>
                </div>
                <div class="detail-field">
                    <div class="label">Phone</div>
                    <div class="value">{{ contact.phone | default('-') }}</div>
                </div>
            </div>
            <div class="form-row">
                <div class="detail-field">
                    <div class="label">Source</div>
                    <div class="value">{{ contact.source | default('-') | replace('_', ' ') | title }}</div>
                </div>
                <div class="detail-field">
                    <div class="label">Company</div>
                    <div class="value">
                        {% if contact.company_id %}
                        <a href="/companies/{{ contact.company_id }}">{{ contact.company_name | default('Unknown') }}</a>
                        {% else %}-{% endif %}
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="detail-field">
                    <div class="label">Owner</div>
                    <div class="value">{{ contact.owner_name | default('-') }}</div>
                </div>
                <div class="detail-field">
                    <div class="label">Added</div>
                    <div class="value">{{ contact.created_at | default('-') }}</div>
                </div>
            </div>
            {% if contact.address %}
            <div class="detail-field">
                <div class="label">Address</div>
                <div class="value">{{ contact.address }}</div>
            </div>
            {% endif %}
        </div>

        <!-- Notes -->
        <div class="card">
            <div class="card-header">
                <h3>Notes</h3>
                <button class="btn btn-outline btn-sm" onclick="document.getElementById('noteForm').style.display='block'">+ Add Note</button>
            </div>

            <div id="noteForm" style="display:none;margin-bottom:16px">
                <textarea class="form-textarea" id="noteContent" placeholder="Write a note..."></textarea>
                <div class="btn-group mt-1">
                    <button class="btn btn-primary btn-sm" onclick="addNote()">Save Note</button>
                    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('noteForm').style.display='none'">Cancel</button>
                </div>
            </div>

            {% for note in notes %}
            <div class="activity-item">
                <div class="activity-dot"></div>
                <div class="activity-content">
                    <div class="activity-text">{{ note.content }}</div>
                    <div class="activity-time">{{ note.created_at }} ‚Äî {{ note.author_name | default('System') }}</div>
                </div>
            </div>
            {% endfor %}
            {% if not notes %}
            <div class="text-center text-muted" style="padding:24px">No notes yet</div>
            {% endif %}
        </div>
    </div>

    <div>
        <!-- Quick Actions -->
        <div class="card mb-3">
            <div class="card-header">
                <h3>Quick Actions</h3>
            </div>
            <a href="/deals/new?contact_id={{ contact.id }}" class="btn btn-outline btn-sm" style="width:100%;justify-content:center;margin-bottom:8px">+ Create Deal</a>
            <a href="/tasks/new?contact_id={{ contact.id }}" class="btn btn-outline btn-sm" style="width:100%;justify-content:center;margin-bottom:8px">+ Create Task</a>
            <a href="/mail/compose?to={{ contact.email }}" class="btn btn-outline btn-sm" style="width:100%;justify-content:center">üìß Send Email</a>
        </div>

        <!-- Related Deals -->
        <div class="card mb-3">
            <div class="card-header">
                <h3>Deals</h3>
            </div>
            {% for deal in deals %}
            <div style="padding:8px 0;border-bottom:1px solid var(--border)">
                <a href="/deals/{{ deal.id }}" class="font-bold" style="font-size:13px">{{ deal.title }}</a>
                <div class="flex justify-between items-center mt-1">
                    <span class="badge stage-{{ deal.stage }}">{{ deal.stage | replace('_', ' ') | title }}</span>
                    <span class="text-success font-bold" style="font-size:13px">${{ "{:,.0f}".format(deal.value or 0) }}</span>
                </div>
            </div>
            {% endfor %}
            {% if not deals %}
            <div class="text-center text-muted" style="padding:20px;font-size:13px">No deals</div>
            {% endif %}
        </div>

        <!-- Related Tasks -->
        <div class="card">
            <div class="card-header">
                <h3>Tasks</h3>
            </div>
            {% for task in tasks %}
            <div style="padding:8px 0;border-bottom:1px solid var(--border)">
                <a href="/tasks/{{ task.id }}" style="font-size:13px">{{ task.title }}</a>
                <div class="flex justify-between items-center mt-1">
                    <span class="badge status-{{ task.status }}">{{ task.status | replace('_', ' ') | title }}</span>
                    <span class="text-muted" style="font-size:12px">{{ task.due_date | default('No due date') }}</span>
                </div>
            </div>
            {% endfor %}
            {% if not tasks %}
            <div class="text-center text-muted" style="padding:20px;font-size:13px">No tasks</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function deleteContact(id) {
    if (!confirm('Delete this contact permanently?')) return;
    const res = await apiCall(`/contacts/api/${id}`, 'DELETE');
    if (res.ok) window.location = '/contacts/';
    else alert(res.data.message || 'Delete failed');
}

async function addNote() {
    const content = document.getElementById('noteContent').value.trim();
    if (!content) return;
    const res = await apiCall('/contacts/api/{{ contact.id }}/notes', 'POST', { content });
    if (res.ok) window.location.reload();
    else alert('Failed to add note');
}
</script>
{% endblock %}
