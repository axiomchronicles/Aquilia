{% extends "base.html" %}

{% block topbar_title %}{{ 'Edit Contact' if contact else 'New Contact' }}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h2>{{ 'Edit Contact' if contact else 'New Contact' }}</h2>
        <p class="subtitle">{{ 'Update contact information' if contact else 'Add a new contact to your CRM' }}</p>
    </div>
    <a href="/contacts/" class="btn btn-outline">‚Üê Back to Contacts</a>
</div>

<div id="alertBox" class="alert"></div>

<div class="card" style="max-width:800px">
    <form id="contactForm" onsubmit="return handleSubmit(event)">
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">First Name *</label>
                <input type="text" class="form-input" id="firstName" value="{{ contact.first_name | default('') }}" required>
            </div>
            <div class="form-group">
                <label class="form-label">Last Name *</label>
                <input type="text" class="form-input" id="lastName" value="{{ contact.last_name | default('') }}" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Email *</label>
                <input type="email" class="form-input" id="email" value="{{ contact.email | default('') }}" required>
            </div>
            <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="text" class="form-input" id="phone" value="{{ contact.phone | default('') }}">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Title / Position</label>
            <input type="text" class="form-input" id="title" value="{{ contact.title | default('') }}" placeholder="e.g. VP of Sales">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select" id="status">
                    {% for s in ['lead', 'prospect', 'qualified', 'customer', 'churned'] %}
                    <option value="{{ s }}" {% if contact and contact.status == s %}selected{% elif not contact and s == 'lead' %}selected{% endif %}>{{ s | title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Source</label>
                <select class="form-select" id="source">
                    {% for s in ['website', 'referral', 'cold_call', 'social_media', 'trade_show', 'other'] %}
                    <option value="{{ s }}" {% if contact and contact.source == s %}selected{% endif %}>{{ s | replace('_', ' ') | title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Company</label>
                <select class="form-select" id="companyId">
                    <option value="">No Company</option>
                    {% for c in companies %}
                    <option value="{{ c.id }}" {% if contact and contact.company_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Owner</label>
                <select class="form-select" id="ownerId">
                    <option value="">Unassigned</option>
                    {% for u in users %}
                    <option value="{{ u.id }}" {% if contact and contact.owner_id == u.id %}selected{% endif %}>{{ u.first_name }} {{ u.last_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Address</label>
            <textarea class="form-textarea" id="address" rows="2" placeholder="Street, City, State, ZIP">{{ contact.address | default('') }}</textarea>
        </div>

        <div class="btn-group mt-2">
            <button type="submit" class="btn btn-primary" id="submitBtn">{{ 'Update Contact' if contact else 'Create Contact' }}</button>
            <a href="/contacts/" class="btn btn-ghost">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
const isEdit = {{ 'true' if contact else 'false' }};
const contactId = {{ contact.id if contact else 'null' }};

async function handleSubmit(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    const alert = document.getElementById('alertBox');
    btn.textContent = 'Saving...';

    const data = {
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value || null,
        title: document.getElementById('title').value || null,
        status: document.getElementById('status').value,
        source: document.getElementById('source').value,
        company_id: document.getElementById('companyId').value ? parseInt(document.getElementById('companyId').value) : null,
        owner_id: document.getElementById('ownerId').value ? parseInt(document.getElementById('ownerId').value) : null,
        address: document.getElementById('address').value || null
    };

    try {
        const url = isEdit ? `/contacts/api/${contactId}` : '/contacts/api/';
        const method = isEdit ? 'PUT' : 'POST';
        const res = await apiCall(url, method, data);

        if (res.ok) {
            const id = isEdit ? contactId : res.data.contact?.id || res.data.id;
            window.location = `/contacts/${id}`;
        } else {
            alert.textContent = res.data.message || JSON.stringify(res.data.errors || res.data);
            alert.className = 'alert alert-error';
        }
    } catch (err) {
        alert.textContent = 'Connection error';
        alert.className = 'alert alert-error';
    }

    btn.textContent = isEdit ? 'Update Contact' : 'Create Contact';
}
</script>
{% endblock %}
