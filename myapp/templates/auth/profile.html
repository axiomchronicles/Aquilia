{% extends "base.html" %}

{% block topbar_title %}Profile & Settings{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h2>Profile Settings</h2>
        <p class="subtitle">Manage your account information</p>
    </div>
</div>

<div id="alertBox" class="alert"></div>

<div class="grid-2">
    <div class="card">
        <div class="card-header">
            <h3>Account Information</h3>
        </div>
        <form id="profileForm" onsubmit="return handleProfileUpdate(event)">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-input" id="firstName" value="{{ user.first_name | default('') }}">
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-input" id="lastName" value="{{ user.last_name | default('') }}">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="email" value="{{ user.email | default('') }}" readonly style="opacity:0.6">
            </div>
            <div class="form-group">
                <label class="form-label">Role</label>
                <input type="text" class="form-input" value="{{ user.role | default('rep') }}" readonly style="opacity:0.6">
            </div>
            <button type="submit" class="btn btn-primary" id="saveBtn">Save Changes</button>
        </form>
    </div>

    <div>
        <div class="card mb-3">
            <div class="card-header">
                <h3>Session</h3>
            </div>
            <div class="detail-field">
                <div class="label">Status</div>
                <div class="value"><span class="badge badge-success">Active</span></div>
            </div>
            <div class="detail-field">
                <div class="label">Member Since</div>
                <div class="value">{{ user.created_at | default('N/A') }}</div>
            </div>
            <div class="mt-2">
                <a href="#" onclick="logout(event)" class="btn btn-danger btn-sm">Sign Out</a>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>Quick Stats</h3>
            </div>
            <div class="detail-field">
                <div class="label">Assigned Contacts</div>
                <div class="value font-bold">{{ stats.contacts | default(0) }}</div>
            </div>
            <div class="detail-field">
                <div class="label">Open Deals</div>
                <div class="value font-bold">{{ stats.deals | default(0) }}</div>
            </div>
            <div class="detail-field">
                <div class="label">Pending Tasks</div>
                <div class="value font-bold">{{ stats.tasks | default(0) }}</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function handleProfileUpdate(e) {
    e.preventDefault();
    const btn = document.getElementById('saveBtn');
    const alert = document.getElementById('alertBox');
    btn.textContent = 'Saving...';

    try {
        const res = await apiCall('/auth/api/me', 'PUT', {
            first_name: document.getElementById('firstName').value,
            last_name: document.getElementById('lastName').value
        });

        if (res.ok) {
            alert.textContent = 'Profile updated successfully!';
            alert.className = 'alert alert-success';
        } else {
            alert.textContent = res.data.message || 'Update failed';
            alert.className = 'alert alert-error';
        }
    } catch (err) {
        alert.textContent = 'Connection error';
        alert.className = 'alert alert-error';
    }

    btn.textContent = 'Save Changes';
}
</script>
{% endblock %}
