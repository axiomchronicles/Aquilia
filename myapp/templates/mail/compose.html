{% extends "base.html" %}

{% block topbar_title %}{{ 'Send Email' if compose else 'New Campaign' }}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h2>{{ 'Send Email' if compose else 'New Email Campaign' }}</h2>
        <p class="subtitle">{{ 'Send a direct email to a contact' if compose else 'Create and schedule an email campaign' }}</p>
    </div>
    <a href="/mail/" class="btn btn-outline">‚Üê Back</a>
</div>

<div id="alertBox" class="alert"></div>

{% if compose %}
<!-- Direct Email Form -->
<div class="card" style="max-width:700px">
    <form id="emailForm" onsubmit="return handleSendEmail(event)">
        <div class="form-group">
            <label class="form-label">To (Email) *</label>
            <input type="email" class="form-input" id="toEmail" value="{{ to | default('') }}" required placeholder="recipient@example.com">
        </div>
        <div class="form-group">
            <label class="form-label">Contact (optional)</label>
            <select class="form-select" id="contactId">
                <option value="">Select Contact</option>
                {% for c in contacts %}
                <option value="{{ c.id }}" {% if c.email == to %}selected{% endif %}>{{ c.first_name }} {{ c.last_name }} ({{ c.email }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Subject *</label>
            <input type="text" class="form-input" id="subject" required placeholder="Email subject">
        </div>
        <div class="form-group">
            <label class="form-label">Body *</label>
            <textarea class="form-textarea" id="body" required placeholder="Write your email..." style="min-height:200px"></textarea>
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-primary" id="sendBtn">üìß Send Email</button>
            <a href="/mail/" class="btn btn-ghost">Cancel</a>
        </div>
    </form>
</div>

{% else %}
<!-- Campaign Form -->
<div class="card" style="max-width:700px">
    <form id="campaignForm" onsubmit="return handleCreateCampaign(event)">
        <div class="form-group">
            <label class="form-label">Campaign Name *</label>
            <input type="text" class="form-input" id="name" required placeholder="e.g. Monthly Newsletter">
        </div>
        <div class="form-group">
            <label class="form-label">Email Subject *</label>
            <input type="text" class="form-input" id="subject" required placeholder="Email subject line">
        </div>
        <div class="form-group">
            <label class="form-label">Email Body *</label>
            <textarea class="form-textarea" id="body" required placeholder="Write your campaign email..." style="min-height:250px"></textarea>
        </div>
        <div class="form-group">
            <label class="form-label">Target</label>
            <select class="form-select" id="target">
                <option value="all">All Contacts</option>
                <option value="leads">Leads Only</option>
                <option value="customers">Customers Only</option>
            </select>
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-primary" id="createBtn">Create Campaign</button>
            <a href="/mail/" class="btn btn-ghost">Cancel</a>
        </div>
    </form>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
async function handleSendEmail(e) {
    e.preventDefault();
    const btn = document.getElementById('sendBtn');
    const alert = document.getElementById('alertBox');
    btn.textContent = 'Sending...';

    try {
        const res = await apiCall('/mail/api/send', 'POST', {
            to: document.getElementById('toEmail').value,
            subject: document.getElementById('subject').value,
            body: document.getElementById('body').value,
            contact_id: document.getElementById('contactId').value ? parseInt(document.getElementById('contactId').value) : null
        });

        if (res.ok) {
            alert.textContent = 'Email sent successfully!';
            alert.className = 'alert alert-success';
            setTimeout(() => window.location = '/mail/', 1500);
        } else {
            alert.textContent = res.data.message || 'Send failed';
            alert.className = 'alert alert-error';
        }
    } catch (err) {
        alert.textContent = 'Connection error';
        alert.className = 'alert alert-error';
    }

    btn.textContent = 'üìß Send Email';
}

async function handleCreateCampaign(e) {
    e.preventDefault();
    const btn = document.getElementById('createBtn');
    const alert = document.getElementById('alertBox');
    btn.textContent = 'Creating...';

    try {
        const res = await apiCall('/mail/api/campaigns', 'POST', {
            name: document.getElementById('name').value,
            subject: document.getElementById('subject').value,
            body: document.getElementById('body').value,
            target: document.getElementById('target').value
        });

        if (res.ok) {
            alert.textContent = 'Campaign created!';
            alert.className = 'alert alert-success';
            setTimeout(() => window.location = '/mail/', 1200);
        } else {
            alert.textContent = res.data.message || 'Creation failed';
            alert.className = 'alert alert-error';
        }
    } catch (err) {
        alert.textContent = 'Connection error';
        alert.className = 'alert alert-error';
    }

    btn.textContent = 'Create Campaign';
}
</script>
{% endblock %}
