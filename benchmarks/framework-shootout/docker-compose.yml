# Framework Shootout — Docker Compose
# Usage: docker compose up -d --build

x-common: &common
  restart: unless-stopped
  deploy:
    resources:
      limits:
        cpus: "2.0"
        memory: 512M
  environment:
    DATABASE_URL: "postgresql://bench:bench@postgres:5432/bench"

services:
  # ── Infrastructure ──────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: bench
      POSTGRES_PASSWORD: bench
      POSTGRES_DB: bench
    volumes:
      - ./apps/shared/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bench"]
      interval: 2s
      timeout: 5s
      retries: 10

  # ── Flask (gunicorn + sync workers) ─────────────────────────────────────
  flask:
    <<: *common
    build:
      context: ./apps
      dockerfile: shared/Dockerfile
      args:
        APP_DIR: flask_app
    command: >
      gunicorn app:app
      --bind 0.0.0.0:8080
      --workers 4
      --threads 2
      --timeout 120
      --access-logfile -
    ports:
      - "8081:8080"
    depends_on:
      postgres:
        condition: service_healthy

  # ── Django (gunicorn + sync workers) ────────────────────────────────────
  django:
    <<: *common
    build:
      context: ./apps
      dockerfile: shared/Dockerfile
      args:
        APP_DIR: django_app
    command: >
      gunicorn app:application
      --bind 0.0.0.0:8080
      --workers 4
      --threads 2
      --timeout 120
      --access-logfile -
    ports:
      - "8082:8080"
    depends_on:
      postgres:
        condition: service_healthy

  # ── FastAPI (uvicorn + uvloop) ──────────────────────────────────────────
  fastapi:
    <<: *common
    build:
      context: ./apps
      dockerfile: shared/Dockerfile
      args:
        APP_DIR: fastapi_app
    command: >
      uvicorn app:app
      --host 0.0.0.0
      --port 8080
      --workers 4
      --loop uvloop
      --access-log
    ports:
      - "8083:8080"
    depends_on:
      postgres:
        condition: service_healthy

  # ── Aquilia (uvicorn + uvloop, installed from source) ───────────────────
  aquilia:
    <<: *common
    build:
      context: ../../
      dockerfile: benchmarks/framework-shootout/apps/aquilia_app/Dockerfile
    ports:
      - "8084:8080"
    depends_on:
      postgres:
        condition: service_healthy

  # ── Sanic (built-in server) ────────────────────────────────────────────
  sanic:
    <<: *common
    build:
      context: ./apps
      dockerfile: shared/Dockerfile
      args:
        APP_DIR: sanic_app
    command: >
      sanic app:app
      --host 0.0.0.0
      --port 8080
      --workers 4
      --access-log
    ports:
      - "8085:8080"
    depends_on:
      postgres:
        condition: service_healthy

  # ── Tornado (single-process, its own event loop) ────────────────────────
  tornado:
    <<: *common
    build:
      context: ./apps
      dockerfile: shared/Dockerfile
      args:
        APP_DIR: tornado_app
    command: python app.py
    ports:
      - "8086:8080"
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  pgdata:
